<!-- udacity2.0 -->
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Exercise: Promote to Production</title>
  <link rel="stylesheet" href="../assets/css/bootstrap.min.css">
  <link rel="stylesheet" href="../assets/css/plyr.css">
  <link rel="stylesheet" href="../assets/css/katex.min.css">
  <link rel="stylesheet" href="../assets/css/jquery.mCustomScrollbar.min.css">
  <link rel="stylesheet" href="../assets/css/styles.css">
  <link rel="shortcut icon" type="image/png" href="../assets/img/udacimak.png" />
</head>

<body>
  <div class="wrapper">
    <nav id="sidebar">
  <div class="sidebar-header">
    <h3>Enabling Continuous Delivery with Deployment Pipelines</h3>
  </div>

  <ul class="sidebar-list list-unstyled CTAs">
    <li>
      <a href="../index.html" class="article">Back to Home</a>
    </li>
  </ul>

  <ul class="sidebar-list list-unstyled components">
    <li class="">
      <a href="01. Introduction.html">01. Introduction</a>
    </li>
    <li class="">
      <a href="02. Big Picture.html">02. Big Picture</a>
    </li>
    <li class="">
      <a href="03. Intuition.html">03. Intuition</a>
    </li>
    <li class="">
      <a href="04. Configuration Management.html">04. Configuration Management</a>
    </li>
    <li class="">
      <a href="05. Design an Ansible Playbook.html">05. Design an Ansible Playbook</a>
    </li>
    <li class="">
      <a href="06. Exercise Define Ansible Playbook.html">06. Exercise: Define Ansible Playbook</a>
    </li>
    <li class="">
      <a href="07. Solution Define Ansible Playbook.html">07. Solution: Define Ansible Playbook</a>
    </li>
    <li class="">
      <a href="08. Build an Inventory File.html">08. Build an Inventory File</a>
    </li>
    <li class="">
      <a href="09. Exercise Inventory File.html">09. Exercise: Inventory File</a>
    </li>
    <li class="">
      <a href="10. Solution Inventory File.html">10. Solution: Inventory File</a>
    </li>
    <li class="">
      <a href="11. Remote Control Using Ansible.html">11. Remote Control Using Ansible</a>
    </li>
    <li class="">
      <a href="12. Exercise Remote Control Using Ansible.html">12. Exercise: Remote Control Using Ansible</a>
    </li>
    <li class="">
      <a href="13. Solution Remote Control Using Ansible.html">13. Solution: Remote Control Using Ansible</a>
    </li>
    <li class="">
      <a href="14. Deployment Jobs.html">14. Deployment Jobs</a>
    </li>
    <li class="">
      <a href="15. Infrastructure Creation Jobs.html">15. Infrastructure Creation Jobs</a>
    </li>
    <li class="">
      <a href="16. Exercise Infrastructure Creation.html">16. Exercise: Infrastructure Creation</a>
    </li>
    <li class="">
      <a href="17. Solution Infrastructure Creation.html">17. Solution: Infrastructure Creation</a>
    </li>
    <li class="">
      <a href="18. Configuration and Deployment Jobs.html">18. Configuration and Deployment Jobs</a>
    </li>
    <li class="">
      <a href="19. Exercise Config and Deployment.html">19. Exercise: Config and Deployment</a>
    </li>
    <li class="">
      <a href="20. Solution Config and Deployment.html">20. Solution: Config and Deployment</a>
    </li>
    <li class="">
      <a href="21. Smoke Testing Jobs.html">21. Smoke Testing Jobs</a>
    </li>
    <li class="">
      <a href="22. Exercise Smoke Testing.html">22. Exercise: Smoke Testing</a>
    </li>
    <li class="">
      <a href="23. Solution Smoke Testing.html">23. Solution: Smoke Testing</a>
    </li>
    <li class="">
      <a href="24. Rollback Jobs.html">24. Rollback Jobs</a>
    </li>
    <li class="">
      <a href="25. Exercise Rollback.html">25. Exercise: Rollback</a>
    </li>
    <li class="">
      <a href="26. Solution Rollback.html">26. Solution: Rollback</a>
    </li>
    <li class="">
      <a href="27. Production Candidate Promotion Jobs.html">27. Production Candidate Promotion Jobs</a>
    </li>
    <li class="">
      <a href="28. Exercise Promote to Production.html">28. Exercise: Promote to Production</a>
    </li>
    <li class="">
      <a href="29. Solution Promote to Production.html">29. Solution: Promote to Production</a>
    </li>
    <li class="">
      <a href="30. Lesson Conclusion.html">30. Lesson Conclusion</a>
    </li>
  </ul>

  <ul class="sidebar-list list-unstyled CTAs">
    <li>
      <a href="../index.html" class="article">Back to Home</a>
    </li>
  </ul>
</nav>

    <div id="content">
      <header class="container-fluild header">
        <div class="container">
          <div class="row">
            <div class="col-12">
              <div class="align-items-middle">
                <button type="button" id="sidebarCollapse" class="btn btn-toggle-sidebar">
                  <div></div>
                  <div></div>
                  <div></div>
                </button>

                <h1 style="display: inline-block">28. Exercise: Promote to Production</h1>
              </div>
            </div>
          </div>
        </div>
      </header>

      <main class="container">
        <div class="row">
          <div class="col-12">
            <div class="ud-atom">
  <h3></h3>
  <div>
  <h2 id="exercise-promote-to-production">Exercise: Promote to Production</h2>
<p>Write a set of jobs that promotes a new environment to production and decommissions the old environment in an automated process.</p>
<h3 id="instructions">Instructions:</h3>
<p>There are a few manual steps we need to take to "prime the pump". These manual steps enable steps that will be automated later.</p>
<h4 id="manual-steps">Manual Steps</h4>
<ul>
<li>Create an S3 Bucket manually. If you need help with this, follow the instructions found in the <a href="https://docs.aws.amazon.com/AmazonS3/latest/user-guide/create-bucket.html" rel="noopener noreferrer" target="_blank">documentation</a>.</li>
<li>Make the bucket public. Follow these <a href="https://docs.aws.amazon.com/AmazonS3/latest/dev/website-hosting-custom-domain-walkthrough.html#root-domain-walkthrough-configure-bucket-permissions" rel="noopener noreferrer" target="_blank">steps</a> if you need help.</li>
<li>Create a simple home page (version 1) in html and name it <code>index.html</code>. It could be as simple as:</li>
</ul>
<pre><code class="html language-html">&lt;html&gt;
  &lt;body&gt;
    &lt;h1&gt;Hello World version 1&lt;/h1&gt;
  &lt;/body&gt;
&lt;/html&gt;</code></pre>
<ul>
<li>Add your home page to your bucket. Follow these <a href="https://docs.aws.amazon.com/AmazonS3/latest/dev/website-hosting-custom-domain-walkthrough.html#upload-website-content" rel="noopener noreferrer" target="_blank">steps</a> if you need help. Make sure you can browse to the home page.</li>
<li>We want to use CloudFormation to modify a <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-cloudfront-distribution.html" rel="noopener noreferrer" target="_blank">CloudFront Distribution</a> later on. It will be <em>MUCH</em> easier to do this if CloudFormation was responsible for creating the distribution in the first place, thus creating a "stack" that can be easily accessed. Create a CloudFormation template file named <code>cloudfront.yml</code> with the following contents and execute it:</li>
</ul>
<pre><code>Parameters:
  PipelineID:
    Description: Unique identifier.
    Type: String

Resources:

  CloudFrontOriginAccessIdentity:
    Type: "AWS::CloudFront::CloudFrontOriginAccessIdentity"
    Properties:
      CloudFrontOriginAccessIdentityConfig:
        Comment: Origin Access Identity for Serverless Static Website

  WebpageCDN:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Origins:
          - DomainName: !Sub "${PipelineID}.s3.amazonaws.com"
            Id: webpage
            S3OriginConfig:
              OriginAccessIdentity: !Sub "origin-access-identity/cloudfront/${CloudFrontOriginAccessIdentity}"
        Enabled: True
        DefaultRootObject: index.html
        DefaultCacheBehavior:
          ForwardedValues:
            QueryString: False
          TargetOriginId: webpage
          ViewerProtocolPolicy: allow-all

Outputs:
  PipelineID:
    Value: !Sub ${PipelineID}
    Export:
      Name: PipelineID</code></pre>
<p>Save that file to your repo as you will need it in the automation steps later.</p>
<ul>
<li>Execute the template with the following command:</li>
</ul>
<pre><code>aws cloudformation deploy \
  --template-file cloudfront.yml \
  --stack-name production-distro \
  --parameter-overrides PipelineID="${S3_BUCKET_NAME}" \ # Name of the S3 bucket you created manually.
  --tags project=udapeople &amp;</code></pre>
<h3 id="automation-instructions">Automation Instructions</h3>
<ul>
<li>Create a CloudFormation template named <code>bucket.yml</code> that will create a new S3 bucket and copy production files every time we deploy to production. You can use the following template:</li>
</ul>
<pre><code>Parameters:
  NAME:
    Type: String
Resources:
  WebsiteBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "${NAME}"
      AccessControl: PublicRead
      WebsiteConfiguration:
        IndexDocument: index.html
        ErrorDocument: 404.html
  WebsiteBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref 'WebsiteBucket'
      PolicyDocument:
        Statement:
        - Sid: PublicReadForGetBucketObjects
          Effect: Allow
          Principal: '*'
          Action: s3:GetObject
          Resource: !Join ['', ['arn:aws:s3:::', !Ref 'WebsiteBucket', /*]]</code></pre>
<ul>
<li>Write a job named <code>create_and_deploy_front_end</code> that executes the <code>bucket.yml</code> template. Your CloudFormation command should look like this:</li>
</ul>
<pre><code>aws cloudformation deploy \
  --template-file bucket.yml \
  --stack-name "${CIRCLE_WORKFLOW_ID:0:7}" \ # ${CIRCLE_WORKFLOW_ID:0:7} takes the first 7 chars of the variable CIRCLE_CI_WORKFLOW_ID
  --parameter-overrides PipelineID="${CIRCLE_WORKFLOW_ID:0:7}"</code></pre>
<p>Notice we are passing in the <code>CIRCLE_WORKFLOW_ID</code> to help form the name of our bucket. This helps us to reference the bucket later, if needed.</p>
<ul>
<li>For cleanup after promotion, we need to know which pipeline ID was responsible for the last successful production release. For this, we can query CloudFormation for the information. Write a CircleCI job named <code>get_last_deployment_id</code> that performs the query and saves the id to a file that we can persist to the workspace. For convenience, here's the command that you can use:</li>
</ul>
<pre><code>aws cloudformation \
  list-exports --query "Exports[?Name==\`PipelineID\`].Value" \
  --no-paginate --output text</code></pre>
<p>Save that ID to a file and persist the file to the workspace for other jobs to access.</p>
<ul>
<li>Write a job named <code>promote_to_production</code> that executes our <code>cloudfront.yml</code> CloudFormation template used in the manual steps. Here's the command to execute the template:</li>
</ul>
<pre><code>aws cloudformation deploy \
  --template-file cloudfront.yml \
  --stack-name production-distro \
  --parameter-overrides PipelineID="${CIRCLE_WORKFLOW_ID}"</code></pre>
<p>Notice here we use the stack name <code>production-distro</code> which is the same name we used in the throw-away CloudFormation template above. Also, as you have seen before, we are passing in the Pipeline Id as a parameter.</p>
<ul>
<li>Write a Job Named <code>clean_up_old_front_end</code> that uses the pipeline ID to destroy the previous production version's S3 bucket and CloudFormation stack. To achieve this, you need to retrieve from the workspace the file where the previous Pipeline ID was stored. Once you have the Pipeline ID, use the following commands to clean up:</li>
</ul>
<pre><code>aws s3 rm "s3://${OldPipelineID}" --recursive
aws cloudformation delete-stack --stack-name "${PreviousPipelineID}"</code></pre>
<ul>
<li>Define a Workflow that puts these jobs in order.</li>
<li>Run the pipeline successfully.</li>
<li>Verify version 2 is browsable using CloudFront URL.</li>
</ul>
</div>

</div>
<div class="divider"></div><div class="ud-atom">
  <h3><p>Promote to Production</p></h3>
  <div>
  <div>
  </div>

  <form>
    <fieldset>
      <legend>Task List:</legend>

      <div>
        <input type="checkbox" id="b18baba4-74af-4969-b56b-d2756cf42d43--0">
        <label for="b18baba4-74af-4969-b56b-d2756cf42d43--0"><p>Create a Public S3 Bucket with a Home Page.</p></label>
      </div>
      <div>
        <input type="checkbox" id="b18baba4-74af-4969-b56b-d2756cf42d43--1">
        <label for="b18baba4-74af-4969-b56b-d2756cf42d43--1"><p>Create a CloudFront Distribution for the Bucket.</p></label>
      </div>
      <div>
        <input type="checkbox" id="b18baba4-74af-4969-b56b-d2756cf42d43--2">
        <label for="b18baba4-74af-4969-b56b-d2756cf42d43--2"><p>Modify Home Page.</p></label>
      </div>
      <div>
        <input type="checkbox" id="b18baba4-74af-4969-b56b-d2756cf42d43--3">
        <label for="b18baba4-74af-4969-b56b-d2756cf42d43--3"><p>Write a Job to Create a New S3 Bucket and Copies Files.</p></label>
      </div>
      <div>
        <input type="checkbox" id="b18baba4-74af-4969-b56b-d2756cf42d43--4">
        <label for="b18baba4-74af-4969-b56b-d2756cf42d43--4"><p>Write a Job that Gets the Previous Pipeline ID.</p></label>
      </div>
      <div>
        <input type="checkbox" id="b18baba4-74af-4969-b56b-d2756cf42d43--5">
        <label for="b18baba4-74af-4969-b56b-d2756cf42d43--5"><p>Write a Job that Modifies the CloudFront Distro's Origin Bucket to Our New Bucket.</p></label>
      </div>
      <div>
        <input type="checkbox" id="b18baba4-74af-4969-b56b-d2756cf42d43--6">
        <label for="b18baba4-74af-4969-b56b-d2756cf42d43--6"><p>Write a Job Kills the Old Bucket and Stack.</p></label>
      </div>
      <div>
        <input type="checkbox" id="b18baba4-74af-4969-b56b-d2756cf42d43--7">
        <label for="b18baba4-74af-4969-b56b-d2756cf42d43--7"><p>Define a Workflow that Puts These Jobs In Order.</p></label>
      </div>
      <div>
        <input type="checkbox" id="b18baba4-74af-4969-b56b-d2756cf42d43--8">
        <label for="b18baba4-74af-4969-b56b-d2756cf42d43--8"><p>Verify The Modified Home Page is Browsable.</p></label>
      </div>
    </fieldset>
  </form>

  <div>
    <h4>Task Feedback:</h4>


    <p>Amazing! You made it!</p>
  </div>
</div>


</div>
<div class="divider"></div>
          </div>

          <div class="col-12">
            <p class="text-right">
              <a href="29. Solution Promote to Production.html" class="btn btn-outline-primary mt-4" role="button">Next Concept</a>
            </p>
          </div>
        </div>
      </main>

      <footer class="footer">
        <div class="container">
          <div class="row">
            <div class="col-12">
              <p class="text-center">
                <a href="https://us-udacity.github.io/" target="_blank">【udacity2.0 】If you need more courses, please add wechat：udacity6</a>
              </p>
            </div>
          </div>
        </div>
      </footer>
    </div>
  </div>


  <script src="../assets/js/jquery-3.3.1.min.js"></script>
  <script src="../assets/js/plyr.polyfilled.min.js"></script>
  <script src="../assets/js/bootstrap.min.js"></script>
  <script src="../assets/js/jquery.mCustomScrollbar.concat.min.js"></script>
  <script src="../assets/js/katex.min.js"></script>
  <script>
    // Initialize Plyr video players
    const players = Array.from(document.querySelectorAll('video')).map(p => new Plyr(p));

    // render math equations
    let elMath = document.getElementsByClassName('mathquill');
    for (let i = 0, len = elMath.length; i < len; i += 1) {
      const el = elMath[i];

      katex.render(el.textContent, el, {
        throwOnError: false
      });
    }

    // this hack will make sure Bootstrap tabs work when using Handlebars
    if ($('#question-tabs').length && $('#user-answer-tabs').length) {
      $("#question-tabs a.nav-link").on('click', function () {
        $("#question-tab-contents .tab-pane").hide();
        $($(this).attr("href")).show();
      });
      $("#user-answer-tabs a.nav-link").on('click', function () {
        $("#user-answer-tab-contents .tab-pane").hide();
        $($(this).attr("href")).show();
      });
    } else {
      $("a.nav-link").on('click', function () {
        $(".tab-pane").hide();
        $($(this).attr("href")).show();
      });
    }

    // side bar events
    $(document).ready(function () {
      $("#sidebar").mCustomScrollbar({
        theme: "minimal"
      });

      $('#sidebarCollapse').on('click', function () {
        $('#sidebar, #content').toggleClass('active');
        $('.collapse.in').toggleClass('in');
        $('a[aria-expanded=true]').attr('aria-expanded', 'false');
      });

      // scroll to first video on page loading
      if ($('video').length) {
        $('html,body').animate({ scrollTop: $('div.plyr').prev().offset().top});
      }

      // auto play first video: this may not work with chrome/safari due to autoplay policy
      if (players && players.length > 0) {
        players[0].play();
      }

      // scroll sidebar to current concept
      const currentInSideBar = $( "ul.sidebar-list.components li a:contains('28. Exercise: Promote to Production')" )
      currentInSideBar.css( "text-decoration", "underline" );
      $("#sidebar").mCustomScrollbar('scrollTo', currentInSideBar);
    });
  </script>
</body>

</html>
